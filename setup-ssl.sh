#!/bin/bash

echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –¥–ª—è bookingminiapp.ru..."

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
mkdir -p ssl/booking

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º certbot –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if ! command -v certbot &> /dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ certbot..."
    sudo apt update
    sudo apt install -y certbot
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω—ã
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker-compose down

# –°–æ–∑–¥–∞–µ–º —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
echo "üìú –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout ssl/booking/privkey.pem \
    -out ssl/booking/fullchain.pem \
    -subj "/C=US/ST=State/L=City/O=Organization/CN=bookingminiapp.ru"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
if [ -f "/etc/letsencrypt/live/bookingminiapp.ru/fullchain.pem" ]; then
    echo "‚úÖ –ù–∞–π–¥–µ–Ω—ã Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, –∑–∞–º–µ–Ω—è–µ–º..."
    sudo cp /etc/letsencrypt/live/bookingminiapp.ru/fullchain.pem ssl/booking/
    sudo cp /etc/letsencrypt/live/bookingminiapp.ru/privkey.pem ssl/booking/
    sudo chown $USER:$USER ssl/booking/*.pem
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
chmod 644 ssl/booking/fullchain.pem
chmod 600 ssl/booking/privkey.pem

echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!"
echo "üöÄ –¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å—Ç–∏—Ç–µ: ./deploy.sh"